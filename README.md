# circuit-breaker-demo
## About CircuitBreaker
 > <img src="https://files.readme.io/39cdd54-state_machine.jpg">
 ```
* normal state: CLOSED
* failure rate를 초과한 경우: OPEN
* waitDurationInOpenState 로 설정된 시간 이후: HALF_OPEN
* HALF_OPEN 상태에서 정상동작한다면 CLOSED로, 문제가 지속된다면 OPEN 상태로
```

 > https://resilience4j.readme.io/docs/circuitbreaker

| Config property                               | Default Value                                                         | Description                                                                                                                                                                                                                                                                                                                                                                                                        |
|-----------------------------------------------|-----------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| failureRateThreshold                          | 50                                                                    | Configures the failure rate threshold in percentage.  When the failure rate is equal or greater than the threshold the CircuitBreaker transitions to open and starts short-circuiting calls.                                                                                                                                                                                                                       |
| slowCallRateThreshold                         | 100                                                                   | Configures a threshold in percentage. The CircuitBreaker considers a call as slow when the call duration is greater than slowCallDurationThreshold  When the percentage of slow calls is equal or greater the threshold, the CircuitBreaker transitions to open and starts short-circuiting calls.                                                                                                                 |
| slowCallDurationThreshold                     | 60000 [ms]                                                            | Configures the duration threshold above which calls are considered as slow and increase the rate of slow calls.                                                                                                                                                                                                                                                                                                    |
| permittedNumberOfCallsInHalfOpenState         | 10                                                                    | Configures the number of permitted calls when the CircuitBreaker is half open.                                                                                                                                                                                                                                                                                                                                     |
| slidingWindowType                             | COUNT_BASED                                                           | Configures the type of the sliding window which is used to record the outcome of calls when the CircuitBreaker is closed. Sliding window can either be count-based or time-based.  If the sliding window is COUNT_BASED, the last slidingWindowSize calls are recorded and aggregated. If the sliding window is TIME_BASED, the calls of the last slidingWindowSize seconds recorded and aggregated.               |
| slidingWindowSize                             | 100                                                                   | Configures the size of the sliding window which is used to record the outcome of calls when the CircuitBreaker is closed.                                                                                                                                                                                                                                                                                          |
| minimumNumberOfCalls                          | 100                                                                   | Configures the minimum number of calls which are required (per sliding window period) before the CircuitBreaker can calculate the error rate or slow call rate. For example, if minimumNumberOfCalls is 10, then at least 10 calls must be recorded, before the failure rate can be calculated. If only 9 calls have been recorded the CircuitBreaker will not transition to open even if all 9 calls have failed. |
| waitDurationInOpenState                       | 60000 [ms]                                                            | The time that the CircuitBreaker should wait before transitioning from open to half-open.                                                                                                                                                                                                                                                                                                                          |
| automaticTransitionFromOpenToHalfOpenEnabled  | false                                                                 | If set to true it means that the CircuitBreaker will automatically transition from open to half-open state and no call is needed to trigger the transition.                                                                                                                                                                                                                                                        |
| recordExceptions                              | empty                                                                 | A list of exceptions that are recorded as a failure and thus increase the failure rate. Any exception matching or inheriting from one of the list counts as a failure, unless explicitly ignored via ignoreExceptions. If you specify a list of exceptions, all other exceptions count as a success, unless they are explicitly ignored by ignoreExceptions.                                                       |
| ignoreExceptions                              | empty                                                                 | A list of exceptions that are ignored and neither count as a failure nor success. Any exception matching or inheriting from one of the list will not count as a failure nor success, even if the exceptions is part of recordExceptions.                                                                                                                                                                           |
| recordException                               | throwable -> true  By default all exceptions are recored as failures. | A custom Predicate which evaluates if an exception should be recorded as a failure. The Predicate must return true if the exception should count as a failure. The Predicate must return false, if the exception should count as a success, unless the exception is explicitly ignored by ignoreExceptions.                                                                                                        |
| ignoreException                               | throwable -> false  By default no exception is ignored.               | A custom Predicate which evaluates if an exception should be ignored and neither count as a failure nor success. The Predicate must return true if the exception should be ignored. The Predicate must return false, if the exception should count as a failure.                                                                                                                                                   |

## How to run
* BackService와 FrontService를 실행
 > $ curl http://localhost:8080/test?id={circuit_breaker_name}
<hr/>

* Client -> FrontService(w/ Circuit Breaker) -> BackService
* FrontService -> BackService 간의 Timeout은 3초
* BackService는 임의의 N초 후 응답 (즉, N값이 3초 이상인 경우 Timeout 발생)
* 현재 slidingWindowType "COUNT_BASED", slidingWindowSize "5", minimumNumberOfCalls "2"로 설정
* 5회를 기준으로, 50% 이하의 성공률을 보일 경우 BackService로 요청을 보내지 않고 즉시 fallback 정책이 실행됨
